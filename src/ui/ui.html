<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Layout Alignment</title>
    <style>
        :root{
            --cell-size: 15px;
        }
        body {
            font-family: sans-serif;
            margin: 0;
            background-color: var(--figma-color-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh; /* Ensure body takes full height for centering */
            text-align: center;
            color: var(--figma-color-text);
            font-size: 11px;
        }
        #alignment-grid {
            display: grid; /* Will be controlled by JS, initially might be none */
            grid-template-columns: repeat(3, 15px);
            grid-template-rows: repeat(3, 15px);
            gap: 5px;
            padding: 5px;
            background-color: var(--figma-color-bg-secondary);
            align-items: center;
            border-radius: 5px;
            justify-items: center;
        }
        #alignment-grid:focus {
            outline: 2px solid var(--figma-color-bg-brand);
            outline-offset: 1px;
        }
        .grid-cell {
            width: var(--cell-size);
            height: var(--cell-size);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: default;
            border-radius: 3px;
            content: '';
            background-color: var(--figma-color-icon-tertiary);
            width: 3px;
            height: 3px;
            display: block;
        }
        .grid-cell.selected {
            width: 100%;
            height: 100%;
            background-color: var(--figma-color-bg-brand);
        }
        .grid-cell:focus {
            outline: 2px solid var(--figma-color-bg-brand);
            outline-offset: 1px;
        }
    </style>
</head>
<body>
    <div id="message-container" style="display: none;">
        Select an auto layout frame
    </div>
    <div class="grid-container" style="display: flex;"> <!-- Initially show grid, will be controlled by JS -->
        <div id="alignment-grid" tabindex="0">
            <!-- Cells will be generated by script -->
        </div>
    </div>
    <script>
        // UI logic will go here
        const alignmentGrid = document.getElementById('alignment-grid');
        const gridContainer = document.querySelector('.grid-container');
        const messageContainer = document.getElementById('message-container');

        // Create 9 grid cells
        for (let i = 0; i < 9; i++) {
            const cell = document.createElement('div');
            cell.classList.add('grid-cell');
            cell.dataset.index = i;
            // Cells are not individually focusable, the grid container is.
            // A visual marker will indicate selection.
            alignmentGrid.appendChild(cell);
        }

        // Initial selected cell (e.g., center)
        let selectedIndex = 4; // 0-8, 4 is center

        function updateSelectedCell() {
            const cells = alignmentGrid.querySelectorAll('.grid-cell');
            cells.forEach((cell, index) => {
                if (index === selectedIndex) {
                    cell.classList.add('selected');
                } else {
                    cell.classList.remove('selected');
                }
            });
        }
        
        updateSelectedCell(); // Set initial selection

        // Focus the grid on load
        alignmentGrid.focus();

        // Focus the grid when the window is clicked
        window.addEventListener('click', () => {
            alignmentGrid.focus();
        });

        // Keyboard navigation
        alignmentGrid.onkeydown = (event) => {
            let newIndex = selectedIndex;
            const currentRow = Math.floor(selectedIndex / 3);
            const currentCol = selectedIndex % 3;

            switch (event.key) {
                case 'ArrowUp':
                    if (currentRow > 0) newIndex -= 3;
                    event.preventDefault();
                    break;
                case 'ArrowDown':
                    if (currentRow < 2) newIndex += 3;
                    event.preventDefault();
                    break;
                case 'ArrowLeft':
                    if (currentCol > 0) newIndex -= 1;
                    event.preventDefault();
                    break;
                case 'ArrowRight':
                    if (currentCol < 2) newIndex += 1;
                    event.preventDefault();
                    break;
                case 'Escape':
                    parent.postMessage({ pluginMessage: { type: 'close-dialog' } }, '*');
                    event.preventDefault();
                    break;
                default:
                    return; // Do nothing for other keys
            }

            if (newIndex !== selectedIndex) {
                selectedIndex = newIndex;
                updateSelectedCell();
                // Send message to plugin code to update Figma selection
                parent.postMessage({ pluginMessage: { type: 'set-alignment', index: selectedIndex } }, '*');
            }
        };

        // Listen for messages from the plugin code
        window.onmessage = (event) => {
            const message = event.data.pluginMessage;
            if (!message) return;

            if (message.type === 'set-initial-alignment') {
                if (typeof message.index === 'number' && message.index >= 0 && message.index < 9) {
                    selectedIndex = message.index;
                    updateSelectedCell();
                    // Ensure grid is visible
                }
            } else if (message.type === 'update-visibility') {
                if (message.hasValidSelection) {
                    gridContainer.style.display = 'flex';
                    messageContainer.style.display = 'none';
                } else {
                    gridContainer.style.display = 'none';
                    messageContainer.style.display = 'block'; // Or 'flex' if you want to use flex properties for centering message
                }
            }
        };

        // Request initial visibility state from the plugin
        parent.postMessage({ pluginMessage: { type: 'get-initial-visibility' } }, '*');

    </script>
</body>
</html>
